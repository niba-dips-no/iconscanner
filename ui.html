<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Icon Scanner</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 16px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      background: #ffffff;
    }
    h2 {
      margin: 0 0 16px 0;
      font-size: 14px;
      font-weight: 600;
    }
    .controls {
      margin-bottom: 16px;
      display: flex;
      gap: 8px;
    }
    button {
      padding: 8px 16px;
      background: #0d99ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    button:hover {
      background: #0b7fd9;
    }
    button:active {
      background: #0969b8;
    }
    button.secondary {
      background: #f0f0f0;
      color: #333;
    }
    button.secondary:hover {
      background: #e0e0e0;
    }
    .stats {
      margin-bottom: 16px;
      padding: 12px;
      background: #f7f7f7;
      border-radius: 6px;
      font-size: 11px;
      color: #666;
    }
    .filter-section {
      margin-bottom: 16px;
    }
    .filter-section label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #666;
    }
    .filter-section select {
      width: 100%;
      padding: 8px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-size: 12px;
      background: white;
      cursor: pointer;
    }
    .search-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-size: 12px;
      background: white;
      margin-bottom: 8px;
    }
    .search-input:focus {
      outline: none;
      border-color: #0d99ff;
    }
    .color-filter {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .color-filter-label {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      margin-right: 2px;
    }
    .color-swatch {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      padding: 0;
      background: none;
      transition: border-color 0.15s;
    }
    .color-swatch:hover {
      border-color: #999;
    }
    .color-swatch.active {
      border-color: #0d99ff;
      box-shadow: 0 0 0 1px #0d99ff;
    }
    .color-swatch-all {
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 10px;
      border: 2px solid transparent;
      background: #f0f0f0;
      color: #333;
      cursor: pointer;
      width: auto;
      height: auto;
    }
    .color-swatch-all.active {
      border-color: #0d99ff;
      background: #e3f2fd;
      color: #0d99ff;
    }
    .icon-colors {
      display: flex;
      gap: 3px;
      margin-top: 4px;
    }
    .icon-color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.15);
    }
    .icon-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .icon-item {
      padding: 12px;
      background: #f9f9f9;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .icon-item:hover {
      background: #f0f0f0;
      border-color: #0d99ff;
    }
    .icon-name {
      font-weight: 500;
      margin-bottom: 4px;
      color: #333;
    }
    .library-badge {
      display: inline-block;
      padding: 3px 8px;
      background: #e3f2fd;
      color: #1565c0;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
      vertical-align: middle;
    }
    .library-badge.remote {
      background: #f3e5f5;
      color: #6a1b9a;
    }
    .library-badge.local {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .icon-details {
      font-size: 11px;
      color: #666;
      line-height: 1.5;
    }
    .icon-detail-row {
      display: flex;
      gap: 4px;
    }
    .icon-label {
      color: #999;
    }
    .clickable-value {
      color: #0d99ff;
      cursor: pointer;
    }
    .clickable-value:hover {
      text-decoration: underline;
    }
    .link-button {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: #0d99ff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 10px;
      margin-top: 6px;
      margin-right: 4px;
      cursor: pointer;
      border: none;
      font-weight: 500;
    }
    .link-button:hover {
      background: #0b7fd9;
    }
    .link-button.secondary {
      background: #666;
    }
    .link-button.secondary:hover {
      background: #555;
    }
    .link-button.copy {
      background: #28a745;
    }
    .link-button.copy:hover {
      background: #218838;
    }
    .link-button.select-all-btn {
      background: #6f42c1;
    }
    .link-button.select-all-btn:hover {
      background: #5a32a3;
    }
    .link-button.copied {
      background: #5cb85c;
      pointer-events: none;
    }
    .linked-from {
      margin-top: 6px;
      padding: 6px 8px;
      background: #fff3cd;
      border-left: 3px solid #ffc107;
      border-radius: 3px;
      font-size: 10px;
    }
    .linked-from-label {
      color: #856404;
      font-weight: 600;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #999;
    }
    .resize-handle {
      position: fixed;
      right: 0;
      bottom: 0;
      width: 16px;
      height: 16px;
      cursor: nwse-resize;
      z-index: 100;
    }
    .resize-handle::after {
      content: '';
      position: absolute;
      right: 3px;
      bottom: 3px;
      width: 8px;
      height: 8px;
      border-right: 2px solid #ccc;
      border-bottom: 2px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>Icon Scanner</h2>

  <div class="controls">
    <button id="scan-page">Scan Current Page</button>
    <button id="scan-document" class="secondary">Scan Document</button>
  </div>

  <div id="stats" class="stats" style="display: none;">
    <div><strong>Total icons found:</strong> <span id="icon-count">0</span></div>
    <div><strong>Showing:</strong> <span id="visible-count">0</span></div>
  </div>

  <div id="filter-section" class="filter-section" style="display: none;">
    <input type="text" id="search-input" class="search-input" placeholder="Search icons by name...">
    <div id="color-filter" class="color-filter" style="display: none;"></div>
    <label for="library-filter">Filter by Library:</label>
    <select id="library-filter">
      <option value="all">All Libraries</option>
    </select>
  </div>

  <div id="loading" class="loading" style="display: none;">
    Scanning for icons...
  </div>

  <div id="empty" class="empty-state">
    Click a button above to scan for icons
  </div>

  <div id="icon-list" class="icon-list"></div>
  <div class="resize-handle" id="resize-handle"></div>

  <script>
    const scanPageBtn = document.getElementById('scan-page');
    const scanDocumentBtn = document.getElementById('scan-document');
    const iconList = document.getElementById('icon-list');
    const emptyState = document.getElementById('empty');
    const loadingState = document.getElementById('loading');
    const stats = document.getElementById('stats');
    const iconCount = document.getElementById('icon-count');
    const visibleCount = document.getElementById('visible-count');
    const filterSection = document.getElementById('filter-section');
    const libraryFilter = document.getElementById('library-filter');
    const searchInput = document.getElementById('search-input');
    const colorFilter = document.getElementById('color-filter');

    let allIcons = [];
    let selectedColor = 'all';

    scanPageBtn.onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'scan-page' } }, '*');
      showLoading();
    };

    scanDocumentBtn.onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'scan-document' } }, '*');
      showLoading();
    };

    function showLoading() {
      iconList.innerHTML = '';
      emptyState.style.display = 'none';
      loadingState.style.display = 'block';
      stats.style.display = 'none';
      filterSection.style.display = 'none';
    }

    libraryFilter.onchange = () => {
      filterIcons();
    };

    searchInput.oninput = () => {
      filterIcons();
    };

    function filterIcons() {
      const selectedLibrary = libraryFilter.value;
      const searchTerm = searchInput.value.toLowerCase().trim();
      const items = document.querySelectorAll('.icon-item');
      let visibleItems = 0;

      items.forEach(item => {
        const itemLibrary = item.dataset.library;
        const itemName = item.dataset.name;
        const itemColors = item.dataset.colors || '';
        const matchesLibrary = selectedLibrary === 'all' || itemLibrary === selectedLibrary;
        const matchesSearch = !searchTerm || itemName.includes(searchTerm);
        const matchesColor = selectedColor === 'all' || itemColors.split(',').includes(selectedColor);

        if (matchesLibrary && matchesSearch && matchesColor) {
          item.style.display = '';
          visibleItems++;
        } else {
          item.style.display = 'none';
        }
      });

      visibleCount.textContent = visibleItems;
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'scan-results') {
        displayIcons(msg.icons);
      }
    };

    function displayIcons(icons) {
      loadingState.style.display = 'none';
      allIcons = icons;

      if (icons.length === 0) {
        iconList.innerHTML = '';
        emptyState.style.display = 'block';
        emptyState.textContent = 'No icons found';
        stats.style.display = 'none';
        filterSection.style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      stats.style.display = 'block';
      filterSection.style.display = 'block';
      iconCount.textContent = icons.length;
      visibleCount.textContent = icons.length;

      // Build library filter options
      const libraries = new Set();
      icons.forEach(icon => {
        if (icon.library) {
          libraries.add(icon.library);
        }
      });

      libraryFilter.innerHTML = '<option value="all">All Libraries</option>';
      Array.from(libraries).sort().forEach(lib => {
        const option = document.createElement('option');
        option.value = lib;
        option.textContent = lib;
        libraryFilter.appendChild(option);
      });

      // Build color filter swatches
      const allColors = new Map();
      icons.forEach(icon => {
        if (icon.colors) {
          icon.colors.forEach(c => {
            allColors.set(c, (allColors.get(c) || 0) + 1);
          });
        }
      });

      selectedColor = 'all';
      if (allColors.size > 0) {
        colorFilter.style.display = 'flex';
        const sortedColors = Array.from(allColors.entries()).sort((a, b) => b[1] - a[1]);
        colorFilter.innerHTML = '<span class="color-filter-label">Colors:</span>' +
          '<button class="color-swatch-all active" data-color="all">All</button>' +
          sortedColors.map(([hex, count]) =>
            `<button class="color-swatch" data-color="${hex}" style="background-color: ${hex};" title="${hex} (${count})"></button>`
          ).join('');

        colorFilter.onclick = (e) => {
          const btn = e.target.closest('[data-color]');
          if (!btn) return;
          selectedColor = btn.dataset.color;
          colorFilter.querySelectorAll('.color-swatch, .color-swatch-all').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          filterIcons();
        };
      } else {
        colorFilter.style.display = 'none';
      }

      // Sort icons by library name, then by name
      const sortedIcons = icons.sort((a, b) => {
        const libA = a.library || 'ZZZ';
        const libB = b.library || 'ZZZ';
        if (libA !== libB) {
          return libA.localeCompare(libB);
        }
        return a.name.localeCompare(b.name);
      });

      // Build a group key for each icon (same main component + page = same group)
      const groupKey = (icon) => {
        const key = icon.linkedFrom ? icon.linkedFrom.id : icon.name;
        return key + '::' + icon.page;
      };

      // Count similar icons per group
      const groupCounts = {};
      sortedIcons.forEach(icon => {
        const k = groupKey(icon);
        groupCounts[k] = (groupCounts[k] || 0) + 1;
      });

      iconList.innerHTML = sortedIcons.map(icon => `
        <div class="icon-item" data-id="${icon.id}" data-library="${escapeHtml(icon.library || '')}" data-name="${escapeHtml(icon.name.toLowerCase())}" data-colors="${(icon.colors || []).join(',')}" data-group-key="${escapeHtml(groupKey(icon))}">
          <div class="icon-name">
            ${escapeHtml(icon.name)}
            ${icon.library ? `<span class="library-badge ${icon.linkedFrom?.isRemote ? 'remote' : 'local'}">${escapeHtml(icon.library)}</span>` : ''}
          </div>
          <div class="icon-details">
            <div class="icon-detail-row">
              <span class="icon-label">Type:</span>
              <span>${escapeHtml(icon.type)}</span>
            </div>
            <div class="icon-detail-row">
              <span class="icon-label">Size:</span>
              <span>${icon.width} Ã— ${icon.height}</span>
            </div>
            <div class="icon-detail-row">
              <span class="icon-label">Page:</span>
              <span class="clickable-value" data-select-node="${icon.pageId}">${escapeHtml(icon.page)}</span>
            </div>
            ${icon.parent ? `
            <div class="icon-detail-row">
              <span class="icon-label">Parent:</span>
              <span class="clickable-value" data-select-node="${icon.parentId}">${escapeHtml(icon.parent)}</span>
            </div>
            ` : ''}
            ${icon.colors && icon.colors.length > 0 ? `
            <div class="icon-detail-row">
              <span class="icon-label">Colors:</span>
              <span class="icon-colors">${icon.colors.map(c => `<span class="icon-color-dot" style="background-color: ${c};" title="${c}"></span>`).join('')}</span>
            </div>
            ` : ''}
          </div>
          ${icon.linkedFrom ? `
          <div class="linked-from">
            <span class="linked-from-label">Library:</span> ${escapeHtml(icon.linkedFrom.library)}
            <br>
            <span class="linked-from-label">Main Component:</span> ${escapeHtml(icon.linkedFrom.name)}
            <br>
            <button class="link-button secondary" data-main-component-id="${icon.linkedFrom.id}">Open Main Component</button>
            <button class="link-button copy" data-link="${icon.linkedFrom.link}">Copy Link</button>
          </div>
          ` : ''}
          <div style="margin-top: 6px;">
            <button class="link-button copy" data-link="${icon.link}">Copy Link</button>
            ${groupCounts[groupKey(icon)] > 1 ? `<button class="link-button select-all-btn" data-group-key="${escapeHtml(groupKey(icon))}">Select All on Page (${groupCounts[groupKey(icon)]})</button>` : ''}
          </div>
        </div>
      `).join('');

      // Add click handlers to select nodes (but not on buttons/links/clickable values)
      document.querySelectorAll('.icon-item').forEach(item => {
        item.onclick = (e) => {
          if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a') || e.target.closest('button') || e.target.closest('.clickable-value')) {
            return;
          }
          const id = item.dataset.id;
          parent.postMessage({ pluginMessage: { type: 'select-node', id: id } }, '*');
        };
      });

      // Add Page/Parent click handlers
      document.querySelectorAll('.clickable-value[data-select-node]').forEach(el => {
        el.onclick = (e) => {
          e.stopPropagation();
          parent.postMessage({ pluginMessage: { type: 'select-node', id: el.dataset.selectNode } }, '*');
        };
      });

      // Add "Select All on Page" handlers
      document.querySelectorAll('.select-all-btn').forEach(button => {
        button.onclick = (e) => {
          e.stopPropagation();
          const key = button.dataset.groupKey;
          const ids = Array.from(document.querySelectorAll(`.icon-item[data-group-key="${CSS.escape(key)}"]`)).map(el => el.dataset.id);
          parent.postMessage({ pluginMessage: { type: 'select-nodes', ids } }, '*');
        };
      });

      // Add main component navigation handlers
      document.querySelectorAll('[data-main-component-id]').forEach(button => {
        button.onclick = (e) => {
          e.stopPropagation();
          const mainComponentId = button.dataset.mainComponentId;
          parent.postMessage({ pluginMessage: { type: 'select-node', id: mainComponentId } }, '*');
        };
      });

      // Add copy link functionality
      document.querySelectorAll('.link-button.copy').forEach(button => {
        button.onclick = async (e) => {
          e.stopPropagation();
          const link = button.dataset.link;
          try {
            await navigator.clipboard.writeText(link);
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.classList.add('copied');
            setTimeout(() => {
              button.textContent = originalText;
              button.classList.remove('copied');
            }, 2000);
          } catch (err) {
            console.error('Failed to copy:', err);
            button.textContent = 'Failed';
            setTimeout(() => {
              button.textContent = 'Copy Link';
            }, 2000);
          }
        };
      });
    }

    // Resize handle
    const resizeHandle = document.getElementById('resize-handle');
    let isResizing = false;
    let startX, startY, startWidth, startHeight;

    resizeHandle.onmousedown = (e) => {
      isResizing = true;
      startX = e.clientX;
      startY = e.clientY;
      startWidth = window.innerWidth;
      startHeight = window.innerHeight;
      e.preventDefault();
    };

    document.onmousemove = (e) => {
      if (!isResizing) return;
      const width = Math.max(300, startWidth + (e.clientX - startX));
      const height = Math.max(200, startHeight + (e.clientY - startY));
      parent.postMessage({ pluginMessage: { type: 'resize', width, height } }, '*');
    };

    document.onmouseup = () => {
      isResizing = false;
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
